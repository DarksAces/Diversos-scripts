<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Mobile Movible y Escalable</title>
<style>
  body { 
    background:#fff; 
    color:#000; 
    font-family:Consolas, monospace; 
    font-size:28px; 
    margin:0; 
    height:100vh; 
    overflow:hidden; 
  }
  #banner-top, #banner-bottom { 
    position:fixed; 
    width:100%; 
    display:flex; 
    z-index:10; 
    background:#fff; 
  }
  #banner-top { 
    top:0; 
    height:100px; 
    align-items:flex-start; 
  }
  #banner-bottom { 
    bottom:0; 
    height:100px; 
    justify-content:center; 
    align-items:flex-end; 
  }
  #banner-top img, #banner-bottom img { 
    height:100%; 
    width:auto; 
    display:block; 
    max-width:100%; 
  }
  #content-wrapper { 
    position:absolute; 
    top:100px; 
    bottom:100px; 
    left:0; 
    right:0; 
    overflow-y:auto; 
    padding:10px; 
  }
  #content { 
    white-space:pre-wrap; 
    line-height:32px; 
    text-align:center; 
    min-height: 50px;
  }
  span.selected { 
    background-color:#d0e0ff; 
  }
  img.mobile { 
    user-select:none; 
    max-width:150px; 
    position:absolute; 
    cursor:grab; 
    z-index:9999; 
  }
</style>
</head>
<body>
<div id="banner-top"></div>
<div id="content-wrapper"><div id="content">Cargando...</div></div>
<div id="banner-bottom"></div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  console.log('DOM Cargado');
  
  const wrapper = document.getElementById('content-wrapper');
  const contentDiv = document.getElementById('content');
  let fullText = '';
  let selectedLine = null;

  // Cargar contenido inicial
  try {
    fullText = window.electronAPI.loadFile();
    console.log('Contenido cargado:', fullText.length, 'caracteres');
    
    if (!fullText || fullText.trim() === '') {
      fullText = 'Línea de ejemplo 1\nLínea de ejemplo 2\nLínea de ejemplo 3';
      window.electronAPI.saveFile(fullText);
    }
  } catch (error) {
    console.error('Error cargando archivo:', error);
    fullText = 'Error al cargar el archivo';
  }

  function renderContent() {
    contentDiv.innerHTML = '';
    const lines = fullText.split('\n');
    console.log('Renderizando', lines.length, 'líneas');
    
    lines.forEach((line, idx) => {
      const span = document.createElement('span');
      span.textContent = line + '\n';
      span.dataset.index = idx;
      span.style.display = 'block';
      span.style.userSelect = 'none';
      
      // No permitir selección de primera y última línea
      if (idx !== 0 && idx !== lines.length - 1) {
        span.addEventListener('mouseenter', () => {
          if (selectedLine) selectedLine.classList.remove('selected');
          selectedLine = span;
          selectedLine.classList.add('selected');
        });
      }
      contentDiv.appendChild(span);
    });
  }

  renderContent();

  // Detectar cambios externos
  try {
    window.electronAPI.onFileChange(text => {
      console.log('Archivo cambió externamente');
      const isAtBottom = wrapper.scrollHeight - wrapper.scrollTop <= wrapper.clientHeight + 10;
      fullText = text;
      renderContent();
      if (isAtBottom) wrapper.scrollTop = wrapper.scrollHeight;
    });
  } catch (error) {
    console.error('Error configurando watcher:', error);
  }

  // Borrar línea con Supr
  document.addEventListener('keydown', e => {
    if (e.key === 'Delete' && selectedLine) {
      const index = parseInt(selectedLine.dataset.index);
      const lines = fullText.split('\n');
      if (index !== 0 && index !== lines.length-1) {
        console.log('Borrando línea', index);
        lines.splice(index, 1);
        fullText = lines.join('\n');
        window.electronAPI.saveFile(fullText);
        renderContent();
        selectedLine = null;
      }
    }
  });

  // Cargar banners e imágenes móviles
  try {
    const { bannersTop, mobileImgs, bannersBottom } = window.electronAPI.loadImages();
    console.log('Imágenes cargadas:', {
      top: bannersTop.length,
      mobile: mobileImgs.length,
      bottom: bannersBottom.length
    });

    bannersTop.forEach(src => {
      const img = document.createElement('img');
      img.src = src;
      img.onerror = () => console.error('Error cargando banner top:', src);
      img.onload = () => console.log('Banner top cargado:', src);
      document.getElementById('banner-top').appendChild(img);
    });

    bannersBottom.forEach(src => {
      const img = document.createElement('img');
      img.src = src;
      img.onerror = () => console.error('Error cargando banner bottom:', src);
      img.onload = () => console.log('Banner bottom cargado:', src);
      document.getElementById('banner-bottom').appendChild(img);
    });

    mobileImgs.forEach(src => {
      const img = document.createElement('img');
      img.src = src;
      img.classList.add('mobile');
      img.style.left = Math.random() * (window.innerWidth - 150) + 'px';
      img.style.top = Math.random() * (window.innerHeight - 150) + 'px';
      img.style.width = '150px';
      img.style.height = 'auto';
      
      img.onerror = () => console.error('Error cargando mobile:', src);
      img.onload = () => console.log('Mobile cargado:', src);

      let offsetX, offsetY, isDragging = false, isScaling = false, startY, startHeight;

      img.addEventListener('mousedown', e => {
        if (e.ctrlKey) {
          isScaling = true;
          startY = e.clientY;
          startHeight = img.offsetHeight;
          e.preventDefault();
        } else {
          isDragging = true;
          offsetX = e.clientX - img.offsetLeft;
          offsetY = e.clientY - img.offsetTop;
          img.style.cursor = 'grabbing';
        }
      });

      document.addEventListener('mousemove', e => {
        if (isScaling) {
          img.style.height = Math.max(50, startHeight + (e.clientY - startY)) + 'px';
          img.style.width = 'auto';
        }
        if (isDragging) {
          let newX = e.clientX - offsetX;
          let newY = e.clientY - offsetY;
          newX = Math.max(0, Math.min(window.innerWidth - img.offsetWidth, newX));
          newY = Math.max(0, Math.min(window.innerHeight - img.offsetHeight, newY));
          img.style.left = newX + 'px';
          img.style.top = newY + 'px';
        }
      });

      document.addEventListener('mouseup', () => {
        isDragging = false;
        isScaling = false;
        img.style.cursor = 'grab';
      });

      document.body.appendChild(img);
    });
  } catch (error) {
    console.error('Error cargando imágenes:', error);
  }
  
  console.log('Aplicación inicializada correctamente');
});
</script>
</body>
</html>